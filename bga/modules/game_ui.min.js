const STORAGE_TTL=12e5,GIVEUP_DURATION_STR="6666",GIVEUP_DURATION=6666,MAX_ROUNDS_DISPLAY=10,gameUI={teamData:[],history:[],init:function(e){if(this.dojoGame||(this.dojoGame=e,this.playerId=e.player_id,this.isSpectator=e.isSpectator),!window.game)return void setTimeout((function(){gameUI.init(e)}),100);window.game.onGridChange=function(e){JSON.stringify(gameUI.grid)!==JSON.stringify(e)&&(gameUI.grid&&gameUI.history.push(gameUI.grid),gameUI.setGrid(e),gameUI.saveGrid(),gameUI.shouldSendProgression=!0)},window.game.onProgression=function(e){gameUI.progression=e},window.game.onPuzzleChange=function(e){"puzzleCreation"===gameUI.mode&&(gameUI.puzzle=e)},window.game.onPuzzleResolve=function(t){"play"===gameUI.mode&&(gameUI.setGrid(t),e.isCurrentPlayerActive()&&"playing"===gameUI.getMyData().state&&(gameUI.resolved=!0))},this.stateEmoticons={teamSelecting:"ü§®",teamSelected:"üëç",failed:"üòï",resting:"üòé",creating:"ü§®",created:"üòé",playing:"ü§®",success:"üòé",default:"üò¥"},this.stateLabels={teamSelecting:_("Team selection"),teamSelected:_("Team selected"),failed:_("Failed to solve the puzzle"),resting:_("It's my puzzle"),creating:_("In progress"),created:_("Puzzle created"),playing:_("In progress"),success:_("Success"),default:_("Not yet started")};const securedLive=function(){try{gameUI.live()}catch(e){console.error("Error in gameUI.live",e)}};securedLive(),setInterval(securedLive,500),window.game.setSmart(1==e.prefs[100].value),this.liveLoop=0,this.initialized=!0},getMyData:function(){return this.players[this.playerId]},initLocalStorage:function(e,t){this.storageKey="lr_"+e+"_"+t,this.teamStorageKey="lr_t_"+e+"_"+t;const i=localStorage.length,s=(new Date).getTime(),o=[];for(let e=0;e<i;++e){const t=localStorage.key(e);if(t.startsWith("lr_")){const e=localStorage.getItem(t);JSON.parse(e).expires<s&&o.push(t)}}o.forEach((e=>localStorage.removeItem(e)))},reset:function(){this.setGrid(void 0),this.setup(),this.saveGrid(),this.history=[],this.shouldSendProgression=!0},undo:function(){if(this.history.length){const e=this.history.pop();this.setGrid(e),this.setup({keepLock:!0}),this.saveGrid(),this.shouldSendProgression=!0}},saveGrid:function(){const e={grid:this.grid,expires:(new Date).getTime()+12e5};localStorage.setItem(this.storageKey,JSON.stringify(e))},_saveTeamData:function(){const e={team:this.teamData,expires:(new Date).getTime()+12e5};localStorage.setItem(this.teamStorageKey,JSON.stringify(e))},getSavedGrid:function(){try{const e=localStorage.getItem(this.storageKey);if(e){return JSON.parse(e).grid}}catch(e){}},_getSavedTeamData:function(){try{const e=localStorage.getItem(this.teamStorageKey);if(e){return JSON.parse(e).team}}catch(e){}},clearSavedGrid:function(){localStorage.removeItem(this.storageKey),this.history=[]},clearSavedTeamData:function(){localStorage.removeItem(this.teamStorageKey),this.teamData.forEach((e=>e.grid=void 0))},savePlayerData:function(e,t){const i={id:t,color:e.color,progression:parseInt(e.progression,10),grid:e.grid?JSON.parse(e.grid):void 0,puzzle:e.puzzle?JSON.parse(e.puzzle):void 0,name:e.name,startTime:parseInt(e.start,10),team:parseInt(e.team,10),num:parseInt(e.num,10)};i.running=i.startTime>0,i.running?"54"===e.state?i.state="success":i.state="playing":(i.duration=gameUI.getDurationStr(parseInt(e.duration,10)),"90"===e.state?i.state="teamSelecting":"91"===e.state?i.state="teamSelected":"30"===e.state?i.state="creating":"31"===e.state?i.state="created":"52"===e.state?i.state="failed":["51","54","80"].some((t=>e.state===t))&&100===i.progression?i.state="success":"80"===e.state&&"6666"===e.duration?i.state="failed":i.state="unknown"),this.players[t]=i},setCollectiveGiveup:function(e){this.collectiveGiveupTeams=[0].concat(e.teams.map((e=>+e))),this.collectiveGiveupPlayers=[0].concat(e.players.map((e=>+e)))},buildCollectiveGiveupArea:function(){dojo.place(this.dojoGame.format_block("jstpl_giveup",{giveup_decision_title:_("Would you like to giveup this round (you will receive a point penalty)?"),yes:_("Yes"),no:_("No")}),"left-side",12),$("giveup_decision_yes").onclick=function(){gameUI.giveUpPropose=!0},$("giveup_decision_no").onclick=function(){gameUI.giveUpRefuse=!0}},hideCollectiveGiveup:function(){if(this.teamsCount>0){const e=this.getMyData().team;gameUI.collectiveGiveupTeams[e]=0,Object.keys(gameUI.players).map((t=>{gameUI.players[t].team===e&&(gameUI.collectiveGiveupPlayers[gameUI.players[t].num]=0)})),this.displayCollectiveGiveup()}},displayCollectiveGiveup:function(){if(!this.ended&&this.teamsCount>0){const e=this.getMyData().team,t=this.collectiveGiveupTeams[e],i=[];t?(dojo.style("giveup-decision","display",""),Object.keys(this.players).map((t=>{const s=this.players[t].team,o=this.players[t].num,n=this.collectiveGiveupPlayers[o];s===e&&n&&i.push(this.players[t].name)})),document.getElementById("giveup-decision-players").innerHTML=i.join(", ")):dojo.style("giveup-decision","display","none")}},shouldAddTime:function(){if(!this.realtime||"play"!==this.mode)return!1;const e=document.getElementById("timeToThink_"+this.playerId).innerHTML;if(!("-"==e[0]||"0"==e[0]))return!1;const t=(new Date).getTime()/1e3;return!(this.lastAddTime&&t-this.lastAddTime<2)&&(this.lastAddTime=t,!0)},buildProgressionBars:function(){Object.keys(this.players).map((e=>{this.displayProgression(e,this.players[e].progression,this.players[e].startTime,this.players[e].duration)}))},buildTeamData:function(){const e=this._getSavedTeamData();if(e)return this.teamData=e,void(this.refreshTeamData=!0);const t=this.getMyData().team;t&&!this.teamData.length&&Object.keys(this.players).map((e=>{this.playerId!==+e&&this.players[e].team===t&&this.teamData.push({id:e,color:"#"+this.players[e].color})}))},getTeamPlayersId:function(e){const t=[];return Object.keys(this.players).forEach((i=>{this.players[i].team===e&&t.push(i)})),t},_setTeam:function(){if(this.refreshTeamData){try{window.game.setTeam(this.teamData),this._saveTeamData(this.teamData)}catch(e){console.error("Error in setTeam",e,this.teamData)}this.refreshTeamData=!1}},live:function(){if(this.liveLoop=(this.liveLoop+1)%4,this._setTeam(),this.resolved&&(this.resolved=!1,this.giveUp=!1,this.timeout=!1,this.shouldSendProgression=!1,this.callAction("puzzleResolve",{grid:JSON.stringify(this.grid)},!0,"post"),this.clearSavedGrid()),this.giveUpPropose)this.giveUpPropose=!1,this.shouldSendProgression=!1,this.callAction("giveUpPropose",{grid:JSON.stringify(gameUI.grid)},!0,"post");else if(this.giveUpRefuse)this.giveUpRefuse=!1,this.shouldSendProgression=!1,this.callAction("giveUpRefuse",null,!0);else if(this.timeout||this.giveUp){const e=this.timeout?"timeout":"giveUp";this.giveUp=!1,this.timeout=!1,this.shouldSendProgression=!1,this.mode="solution",this.callAction(e,{grid:JSON.stringify(this.grid)},!0,"post")}else 0!==this.liveLoop&&2!==this.liveLoop||"play"!==this.mode||this.manageTimeLimit();if(this.puzzleCreationEnd&&(this.puzzleCreationEnd=!1,this.shouldSendProgression=!1,this.callAction("creationEnd",{grid:JSON.stringify(this.grid),puzzle:JSON.stringify(this.puzzle)},!0,"post"),this.clearSavedGrid()),this.shouldSendProgression&&(0===this.liveLoop||100===this.progression||this.teamData.length)&&(this.shouldSendProgression=!1,this.running&&!g_archive_mode&&("puzzleCreation"===this.mode||"play"===this.mode))){const e={grid:JSON.stringify(this.grid),progression:this.progression||0,give_time:this.shouldAddTime()};this.callAction("gridChange",e,e.give_time,"post")}if(this.shouldRefreshProgression)this.buildProgressionBars(),this.displayBars(),this.shouldRefreshProgression=!1;else if(!this.ended&&this.realtime){const e=Math.round((new Date).getTime()/1e3);Object.keys(this.players).map((t=>{const i=this.players[t];if(i.startTime||i.duration){let s=i.duration;s||g_archive_mode||(s=gameUI.getDurationStr(gameUI.getDuration(i.startTime,e))),gameUI._displayDuration(t,s)}}))}const e=document.getElementById("page-title"),t=document.getElementById("maingameview_menuheader"),i=document.getElementById("archivecontrol");let s=e.offsetHeight+90;t&&t.offsetHeight&&(s+=t.offsetHeight+30),i&&i.offsetHeight&&(s+=i.offsetHeight);const o=50*Math.floor(e.offsetWidth/50),n=50*Math.floor((window.innerHeight-s)/50);window.game.setAreaSize(o,n);try{dojo.query(".replay_last_move_button")[0].parentNode.parentNode.style.display="none"}catch(e){}},manageTimeLimit:function(){const e=document.getElementById("giveUp");if(e){const t=this.getMyData();if(t.startTime){const i=gameUI.getDuration(t.startTime),s=60*this.timeLimit-i;s<=0?this.timeout=!0:s<=30&&(e.innerHTML=_("Give up")+" ("+s+" "+_("seconds")+")")}}},setGrid:function(e){let t=0;e&&e.forEach((e=>{e.forEach((e=>{e&&7!==e&&t++}))})),this.grid=e,this.placedElements=t},setup:function(e){if(!this.initialized)return void setTimeout((function(){gameUI.setup()}),100);const t={mode:this.mode,elements:this.elements,gridSize:this.gridSize,grid:this.grid,puzzle:this.puzzle,portals:this.portals,transformations:this.transfo||0};e&&Object.keys(e).forEach((i=>t[i]=e[i])),"solution"===this.mode?t.solution=this.solution:this.solution=null,this.grid=window.game.setup(t),dojo.style("root","visibility","visible"),this.running&&!g_archive_mode||window.game.setRunning(!1)},callAction:function(e,t,i,s){this.dojoGame.callAction(e,t,i,s)},displayGrid:function(){console.info("## Display grid ##"),window.game.resetLaser(),dojo.style("lrf_seed","display","none"),!this.isSpectator||this.trainingMode||this.ended?(dojo.style("lrf_spectator_text","display","none"),dojo.style("lrf_main","display","flex")):(dojo.style("lrf_spectator_text","display","flex"),dojo.style("lrf_main","display","none"))},hideGrid:function(){console.info("## Hide grid ##"),dojo.style("lrf_main","display","none")},displayProgression:function(e,t,i,s){try{const o="lrf_info_"+e,n="lrf_progressbar_"+e,a="lrf_counter_"+e,r="lrf_container_"+e,l="lrf_textbar_"+e,d="lrf_emot_"+e,h="lrf_label_"+e;s||!i||g_archive_mode||(s=this.getDurationStr(this.getDuration(i))),dojo.destroy(o),dojo.place(this.dojoGame.format_block("jstpl_progressbar",{iid:o,pid:n,cid:a,sid:r,tid:l,eid:d,lid:h,color:this.players[e].color,progression:t,dec:100-t,text_disp:t>15?"":"none",bar_width:s?"78%":"90%",counter:s||""}),"overall_player_board_"+e)}catch(e){console.error("Error in displayProgression",e)}},displayBars:function(){Object.keys(this.players).map((e=>{try{const t="lrf_progressbar_"+e,i="lrf_textbar_"+e,s="lrf_emot_"+e,o="lrf_label_"+e,n=this.players[e],a=this.samePuzzle&&this.puzzleUser&&this.puzzleUser.id===e?"resting":n.state;document.getElementById(s).innerHTML=this.stateEmoticons[a]||this.stateEmoticons.default,document.getElementById(o).innerHTML=this.stateLabels[a]||this.stateLabels.default,(this.realtime||e==this.playerId)&&["creating","created","playing","success"].some((e=>e===a))?(dojo.style(t,"display",""),dojo.style(i,"display","none")):(dojo.style(t,"display","none"),dojo.style(i,"display",""))}catch(e){console.error("Error in displayBars",e)}}))},_displayDuration:function(e,t){const i="lrf_counter_"+e,s="lrf_container_"+e;try{document.getElementById(i).innerHTML=t,document.getElementById(s).style.width=t?"78%":"90%"}catch(e){console.error("Error in _displayDuration",e)}},getDuration:function(e,t){const i=(t||Math.round((new Date).getTime()/1e3))-e-this.serverTimeDec;return i<0?(this.serverTimeDec+=i,0):i},getDurationStr:function(e){if(!e)return"";if(6666===e)return"0:00";const t=e%60;return((e-t)/60).toString()+":"+t.toString().padStart(2,"0")},spyBoard:function(e){if(!this.trainingMode)return dojo.style("lrf_spectator_text","display","flex"),dojo.style("lrf_main","display","none"),void dojo.style("lrf_spectator","display","none");if(dojo.style("lrf_spectator_text","display","none"),dojo.style("lrf_main","display","flex"),dojo.style_("lrf_spectator","display",this.playersCount>1?"flex":"none"),e&&(this.playerSpied=e,this.grid=this.players[e].grid),!this.modeRandom)if(this.puzzleUsers){const t=this.puzzleUsers[e];this.puzzle=this.players[t].puzzle}else this.puzzle=void 0;this.dojoGame&&this.setup()},buildRoundsPuzzleSelect:function(){this.resultRoundStart=10===this.puzzles.length&&this.round>10?this.round-10:0;for(let e=0;e<this.puzzles.length;e++)dojo.place("<option value='"+(e+this.resultRoundStart)+"'>"+_("Round")+" "+(e+this.resultRoundStart+1)+"</option>","roundSelect")},displaySeedArea:function(){dojo.style("lrf_main","display","none"),dojo.style("lrf_seed","display","flex")},seedValidate:function(e){const t=window.game.getGrid(e);let i=!0;const s=[],o=[];t.length<4?i=!1:(t.forEach(((e,t)=>e.forEach(((e,n)=>{e<0?i=!1:7===e?(o.push(t),o.push(n)):e>0&&s.push(e)})))),(0!==o.length&&4!==o.length||4===t.length&&s.length>14||s.length>20)&&(i=!1)),i?(this.elements=s,this.elementsCount=s.length,this.gridSize=t.length,this.portals=o,this.callAction("seedValidate",{grid:JSON.stringify(t)},!0,"post")):this.dojoGame.showMessage(_("This is not a valid seed code"),"error")},_displaySeed:function(){document.getElementById("lrf_end_seed_input").value=window.game.getSeed(this.grid);const e=document.getElementById("lrf_end_seed_copy");e.title||(e.title=_("Copy to clipboard"),e.onclick=function(){const e=document.getElementById("lrf_end_seed_input").value;navigator.clipboard.writeText(e).then((()=>{dojo.style("lrf_end_seed_copy","display","none"),dojo.style("lrf_end_seed_copied","display",""),setTimeout((function(){dojo.style("lrf_end_seed_copy","display",""),dojo.style("lrf_end_seed_copied","display","none")}),2e3)}))})},displayRoundPuzzle:function(e){console.info("## Display puzzle of round "+e+" ##"),Object.keys(this.players).forEach((e=>{const t="lrf_end_"+e;document.getElementById(t).innerHTML="?"}));const t=String(e).padStart(4,"0"),i="pd_"+t+"_";this.grid=this.puzzles[e-this.resultRoundStart],this._displaySeed(),this.durations.filter((e=>e.pdk.startsWith(i))).forEach((e=>{const t=+e.pdk.substring(i.length),s="lrf_end_"+Object.keys(this.players).map((e=>this.players[e])).find((e=>e.num===t)).id,o="6666"===e.duration?_("Give up"):this.getDurationStr(+e.duration);document.getElementById(s).innerHTML=o}));const s=JSON.stringify(this.grid);Object.keys(this.players).forEach((e=>{const i="pg_"+t+"_"+this.players[e].num;document.getElementById("board_"+e).checked=!1;const o=this.boards.find((e=>e.pgk===i)),n=o&&o.grid?JSON.stringify(o.grid):void 0,a=null==n||n===s?"hidden":"visible";document.getElementById("board_"+e).style.visibility=a}));try{dojo.style("lrf_main","display","flex"),dojo.style("lrf_end","display","flex"),dojo.style("lrf_end_players","display","none"),dojo.style("lrf_end_rounds","display","flex"),this.mode="view",this.solution=null,this.dojoGame&&this.setup()}catch(e){console.error("Error in displayRoundPuzzle",e)}},displayPlayerPuzzle:function(e){console.info("## Display puzzle of player "+e+" ##");try{dojo.style("lrf_spectator","display","none"),dojo.style("lrf_main","display","flex"),dojo.style("lrf_end","display","flex"),dojo.style("lrf_end_players","display","flex"),dojo.style("lrf_end_rounds","display","none");const t=JSON.stringify(this.players[e].grid);Object.keys(this.players).forEach((e=>{const t="lrf_end_"+e;document.getElementById(t).innerHTML="?"})),Object.keys(this.players).forEach((i=>{const s="pg_"+this.players[e].num+"_"+this.players[i].num;document.getElementById("board_"+i).checked=!1;const o=this.boards.find((e=>e.pgk===s)),n=o&&o.grid?JSON.stringify(o.grid):void 0,a=null==n||n===t?"hidden":"visible";document.getElementById("board_"+i).style.visibility=a}));const i="pd_"+this.players[e].num+"_";Object.keys(this.players).forEach((t=>{const i="lrf_end_line_"+t,s=t==e?"none":"";dojo.style(i,"display",s)})),this.durations.filter((e=>e.pdk.startsWith(i))).forEach((e=>{const t=+e.pdk.substring(i.length),s="lrf_end_"+Object.keys(this.players).map((e=>this.players[e])).find((e=>e.num===t)).id,o="6666"===e.duration?_("Give up"):this.getDurationStr(+e.duration);document.getElementById(s).innerHTML=o})),this.mode="view",this.solution=null,this.grid=this.players[e].grid,this._displaySeed(),this.dojoGame&&this.setup()}catch(e){console.error("Error in displayPlayerPuzzle",e)}},displayBoard:function(e){Object.keys(this.players).filter((t=>t!=e)).forEach((e=>document.getElementById("board_"+e).checked=!1)),this.modeRandom?this._displayBoardRound(e):this._displayBoardPlayer(e)},_displayBoardRound:function(e){const t=document.getElementById("roundSelect").value,i=String(t).padStart(4,"0");if(document.getElementById("board_"+e).checked){const s=this.players[e],o="pg_"+i+"_"+s.num,n="pd_"+i+"_"+s.num,a=this.durations.find((e=>e.pdk===n));a&&"6666"!=a.duration?(this.mode="view",this.solution=null):(this.mode="solution",this.solution=this.puzzles[t-this.resultRoundStart]),this.puzzle=void 0,this.grid=this.boards.find((e=>e.pgk===o)).grid,this.dojoGame&&this.setup()}else this.displayRoundPuzzle(t)},_displayBoardPlayer:function(e){const t=document.getElementById("playerSelect").value;if(document.getElementById("board_"+e).checked){const i=this.players[e],s=this.players[t],o="pg_"+s.num+"_"+i.num,n="pd_"+s.num+"_"+i.num,a=this.durations.find((e=>e.pdk===n));a&&"6666"!=a.duration?(this.mode="view",this.solution=null,this.grid=this.boards.find((e=>e.pgk===o)).grid):(this.mode="solution",this.solution=s.grid,this.puzzle=void 0,this.grid=this.boards.find((e=>e.pgk===o)).grid),this.dojoGame&&this.setup()}else this.displayPlayerPuzzle(t)},refreshPuzzle:function(e){try{if(!e&&this.playerSpied&&(e=this.playerSpied),this.playerSpied===e){if(this.grid=this.players[e].grid,!this.modeRandom)if(this.isSpectator&&this.puzzleUsers&&!this.ended){const t=this.puzzleUsers[e];this.puzzle=this.players[t].puzzle}else this.puzzle=void 0;this.setup()}}catch(e){console.error("Error in refreshPuzzle",e)}},displayTeamSelection:function(){dojo.style("lrf_main","display","none"),dojo.style("lrf_teams","display","flex");const e=this.getMyData().team;e&&dojo.addClass("lrf_team_"+e,"lrf_team_selected"),2==this.teamsCount&&dojo.style("lrf_team_3","display","none")},hideTeamSelection:function(){dojo.style("lrf_main","display",""),dojo.style("lrf_teams","display","none")},selectTeam:function(e){for(let t=1;t<=3;t++)e===t?dojo.addClass("lrf_team_"+t,"lrf_team_selected"):dojo.removeClass("lrf_team_"+t,"lrf_team_selected");const t=this.getMyData();t.team!==e&&this.callAction("teamSelect",{no:t.num,team:e},!0)},displayPlayerTeam:function(e){const t="player_name_"+e,i="icon_"+e,s=["","üßô","üßõ","üëΩ"][this.players[e].team];dojo.destroy(i),dojo.place("<span id='"+i+"'>"+s+"&nbsp;</span>",$(t).firstElementChild,0)},displayPlayerHearts:function(e){const t=this.isSpectator?this.playerSpied:this.playerId,i="player_board_"+t,s="icon_"+t,o=e+"&nbsp;üíó";dojo.destroy(s),dojo.place("<span id='"+s+"'>&nbsp;&nbsp;&nbsp;"+o+"&nbsp;</span>",$(i).firstElementChild,4)},displayPlayerIcons:function(){this.soloMode&&101!==this.soloMode?this.displayPlayerHearts(this.hearts):gameUI.teamsCount&&Object.keys(this.players).map((e=>{this.displayPlayerTeam(e)}))}};