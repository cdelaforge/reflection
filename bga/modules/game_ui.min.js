const STORAGE_TTL=12e5,gameUI={teamData:[],history:[],init:function(e){if(this.dojoGame||(this.dojoGame=e,this.playerId=e.player_id),!window.game)return void setTimeout((function(){gameUI.init(e)}),100);window.game.onGridChange=function(e){JSON.stringify(gameUI.grid)!==JSON.stringify(e)&&(gameUI.grid&&gameUI.history.push(gameUI.grid),gameUI.setGrid(e),gameUI.saveGrid(),gameUI.shouldSendProgression=!0)},window.game.onProgression=function(e){gameUI.progression=e},window.game.onPuzzleChange=function(e){"puzzleCreation"===gameUI.mode&&(gameUI.puzzle=e)},window.game.onPuzzleResolve=function(t){"play"===gameUI.mode&&(gameUI.setGrid(t),e.isCurrentPlayerActive()&&(gameUI.resolved=!0))};const securedLive=function(){try{gameUI.live()}catch(e){console.error("Error in gameUI.live",e)}};securedLive(),setInterval(securedLive,500),this.liveLoop=0,this.initialized=!0},initLocalStorage:function(e,t){this.storageKey="lr_"+e+"_"+t,this.teamStorageKey="lr_t_"+e+"_"+t;const i=localStorage.length,s=(new Date).getTime(),o=[];for(let e=0;e<i;++e){const t=localStorage.key(e);if(t.startsWith("lr_")){const e=localStorage.getItem(t);JSON.parse(e).expires<s&&o.push(t)}}o.forEach((e=>localStorage.removeItem(e)))},reset:function(){this.setGrid(void 0),this.setup(),this.saveGrid(),this.history=[],this.shouldSendProgression=!0},undo:function(){if(this.history.length){const e=this.history.pop();this.setGrid(e),this.setup(),this.saveGrid(),this.shouldSendProgression=!0}},saveGrid:function(){const e={grid:this.grid,expires:(new Date).getTime()+12e5};localStorage.setItem(this.storageKey,JSON.stringify(e))},_saveTeamData:function(){const e={team:this.teamData,expires:(new Date).getTime()+12e5};localStorage.setItem(this.teamStorageKey,JSON.stringify(e))},getSavedGrid:function(){try{const e=localStorage.getItem(this.storageKey);if(e){return JSON.parse(e).grid}}catch(e){}},_getSavedTeamData:function(){try{const e=localStorage.getItem(this.teamStorageKey);if(e){return JSON.parse(e).team}}catch(e){}},clearSavedGrid:function(){localStorage.removeItem(this.storageKey),this.history=[]},clearSavedTeamData:function(){localStorage.removeItem(this.teamStorageKey),this.teamData.forEach((e=>e.grid=void 0))},savePlayerData:function(e,t){const i={id:t,color:e.color,progression:parseInt(e.progression,10),grid:e.grid?JSON.parse(e.grid):void 0,puzzle:e.puzzle?JSON.parse(e.puzzle):void 0,name:e.name,startTime:parseInt(e.start,10),team:parseInt(e.team,10),num:parseInt(e.num,10)};i.running=i.startTime>0,i.running?i.state="playing":(i.duration=gameUI.getDurationStr(parseInt(e.duration,10)),"90"===e.state?i.state="teamSelecting":"91"===e.state?i.state="teamSelected":"30"===e.state?i.state="creating":"52"===e.state?i.state="failed":"51"===e.state&&100===i.progression?i.state="success":"80"===e.state&&"6666"===e.duration?i.state="failed":"80"===e.state&&100===i.progression?i.state="success":i.state="unknown"),this.players[t]=i},shouldAddTime:function(){if(!this.realtime||"play"!==this.mode)return!1;const e=document.getElementById("timeToThink_"+this.playerId).innerHTML;return"-"==e[0]||"0"==e[0]},buildProgressionBars:function(){Object.keys(this.players).map((e=>{this.displayProgression(e,this.players[e].progression,this.players[e].startTime,this.players[e].duration)}))},buildTeamDataAndRegister:function(){const e=this.players[this.playerId].team,t=this._getSavedTeamData();e&&!this.teamData.length&&Object.keys(this.players).map((i=>{this.playerId!==+i&&this.players[i].team===e&&(t||this.teamData.push({id:i,color:"#"+this.players[i].color}),this.dojoGame.subscribe("gridChange_"+i,"notif_gridChange"))})),t&&(this.teamData=t,this.refreshTeamData=!0)},_setTeam:function(){if(this.refreshTeamData){try{window.game.setTeam(this.teamData),this._saveTeamData(this.teamData)}catch(e){console.error("Error in setTeam",e,this.teamData)}this.refreshTeamData=!1}},live:function(){if(this.liveLoop=(this.liveLoop+1)%4,this._setTeam(),this.resolved&&(this.resolved=!1,this.giveUp=!1,this.timeout=!1,this.shouldSendProgression=!1,this.callAction("puzzleResolve",{grid:JSON.stringify(this.grid)},!0),this.clearSavedGrid()),this.timeout||this.giveUp){const e=this.timeout?"timeout":"giveUp";this.giveUp=!1,this.timeout=!1,this.shouldSendProgression=!1,this.callAction(e,null,!0)}if(this.puzzleCreationEnd&&(this.puzzleCreationEnd=!1,this.shouldSendProgression=!1,this.callAction("creationEnd",{grid:JSON.stringify(this.grid),puzzle:JSON.stringify(this.puzzle)},!0),this.clearSavedGrid()),this.shouldSendProgression&&(0===this.liveLoop||100===this.progression||this.teamData.length)&&(this.shouldSendProgression=!1,this.running&&!g_archive_mode&&("puzzleCreation"===this.mode||"play"===this.mode))){const e={grid:JSON.stringify(this.grid),progression:this.progression||0,give_time:this.shouldAddTime()};this.callAction("gridChange",e,e.give_time)}if(this.shouldRefreshProgression)this.buildProgressionBars(),this.displayBars(),this.shouldRefreshProgression=!1;else if(!this.ended){const e=Math.round((new Date).getTime()/1e3);Object.keys(this.players).map((t=>{const i=this.players[t];if(i.startTime||i.duration){let s=i.duration;s||g_archive_mode||(s=gameUI.getDurationStr(gameUI.getDuration(i.startTime,e))),gameUI.displayDuration(t,s)}}))}0!==this.liveLoop&&2!==this.liveLoop||"play"!==this.mode||this.manageTimeLimit();const e=document.getElementById("page-title"),t=document.getElementById("maingameview_menuheader"),i=document.getElementById("archivecontrol");let s=e.offsetHeight+90;t&&t.offsetHeight&&(s+=t.offsetHeight+30),i&&i.offsetHeight&&(s+=i.offsetHeight);const o=50*Math.floor(e.offsetWidth/50),a=50*Math.floor((window.innerHeight-s)/50);if(window.game.setAreaSize(o,a),this.prevAreaWidth!==o){this.prevAreaWidth=o;const t=this;setTimeout((()=>{t.setRootMargin(e)}),100)}else this.setRootMargin(e);try{dojo.query(".replay_last_move_button")[0].parentNode.parentNode.style.display="none"}catch(e){}},manageTimeLimit:function(){const e=document.getElementById("giveUp");if(e){const t=this.players[this.playerId];if(t.startTime){const i=gameUI.getDuration(t.startTime),s=60*this.timeLimit-i;s<=0?this.timeout=!0:s<=30&&(e.innerHTML=_("Give up")+" ("+s+" "+_("seconds")+")")}}},setRootMargin:function(e){const t=document.getElementById("root");if(t.offsetWidth){const i=Math.floor((e.offsetWidth-t.offsetWidth)/2);t.style.marginLeft=i+"px"}},setGrid:function(e){let t=0;e&&e.forEach((e=>{e.forEach((e=>{e&&7!==e&&t++}))})),this.grid=e,this.placedElements=t},setup:function(){if(!this.initialized)return void setTimeout((function(){gameUI.setup()}),100);const e={mode:this.mode,elements:this.elements,gridSize:this.gridSize,grid:this.grid,puzzle:this.puzzle,portals:this.portals};"solution"===this.mode?e.solution=this.solution:this.solution=null,this.grid=window.game.setup(e),dojo.style("root","visibility","visible"),this.running&&!g_archive_mode||window.game.setRunning(!1)},callAction:function(e,t,i,s){this.dojoGame.callAction(e,t,i,s)},displayGrid:function(){console.info("## Display grid ##"),timer.abort(),!this.dojoGame.isSpectator||this.trainingMode||this.ended?(dojo.style("lrf_spectator","display","none"),dojo.style("lrf_main","display","flex"),dojo.style("lrf_end","display",this.dojoGame.isSpectator?"flex":"none"),dojo.style("lrf_timer","display","none")):(dojo.style("lrf_spectator","display","flex"),dojo.style("lrf_main","display","none"))},hideGrid:function(){console.info("## Hide grid ##"),timer.abort(),dojo.style("lrf_main","display","none")},displayProgression:function(e,t,i,s){try{const o="info_"+e,a="progressbar_"+e,r="counter_"+e,n="container_"+e,l="resting_"+e,d="fail_"+e,h="afkId_"+e,c="selectingId_"+e,m="selectedId_"+e;s||!i||g_archive_mode||(s=this.getDurationStr(this.getDuration(i))),dojo.destroy(o),dojo.place(this.dojoGame.format_block("jstpl_progressbar",{iid:o,pid:a,cid:r,sid:n,rid:l,fid:d,aid:h,tid:c,oid:m,my_puzzle:_("It's my puzzle"),failed:_("Failed to solve the puzzle"),sleeping:_("Not yet started"),selecting:_("Team selection"),selected:_("Team validated"),color:this.players[e].color,progression:t,dec:100-t,text_disp:t>15?"":"none",bar_width:s?"78%":"90%",counter:s||""}),"overall_player_board_"+e)}catch(e){console.error("Error in displayProgression",e)}},displayBars:function(){Object.keys(this.players).map((e=>{try{const t="progressbar_"+e,i="resting_"+e,s="fail_"+e,o="afkId_"+e,a="selectingId_"+e,r="selectedId_"+e,n=this.players[e];switch(dojo.style(t,"display","none"),dojo.style(s,"display","none"),dojo.style(i,"display","none"),dojo.style(o,"display","none"),dojo.style(a,"display","none"),dojo.style(r,"display","none"),n.state){case"teamSelecting":dojo.style(a,"display","");break;case"teamSelected":dojo.style(r,"display","");break;case"failed":dojo.style(s,"display","");break;case"playing":case"success":case"creating":dojo.style(t,"display","");break;default:dojo.style(o,"display","")}}catch(e){console.error("Error in displayBars",e)}}))},displayDuration:function(e,t){const i="counter_"+e,s="container_"+e;try{document.getElementById(i).innerHTML=t,document.getElementById(s).style.width=t?"78%":"90%"}catch(e){console.error("Error in displayDuration",e)}},getDuration:function(e,t){const i=(t||Math.round((new Date).getTime()/1e3))-e-this.serverTimeDec;return i<0?(this.serverTimeDec+=i,0):i},getDurationStr:function(e){if(!e)return"";if(6666===e)return"0:00";const t=e%60;return((e-t)/60).toString()+":"+t.toString().padStart(2,"0")},displayTimer:function(e){console.info("## Display timer ##"),dojo.style("lrf_main","display","none"),dojo.style("lrf_timer","display","block"),timer.start(e)},buildRoundsPuzzleSelect:function(){for(let e=0;e<this.puzzles.length;e++)dojo.place("<option value='"+e+"'>"+_("Round")+" "+(e+1)+"</option>","roundSelect")},displayRoundPuzzle:function(e){console.info("## Display rounds's puzzles ##");try{dojo.style("lrf_main","display","flex"),dojo.style("lrf_timer","display","none"),dojo.style("lrf_end","display","none"),dojo.style("lrf_end_rnd","display","flex"),this.mode="view",this.grid=this.puzzles[e],this.dojoGame&&this.setup()}catch(e){console.error("Error in displayPuzzle",e)}},displayPuzzle:function(e){console.info("## Display player's puzzles ##");try{if(!this.dojoGame.isSpectator||this.trainingMode||this.ended){if(dojo.style("lrf_spectator","display","none"),dojo.style("lrf_main","display","flex"),dojo.style("lrf_timer","display","none"),dojo.style("lrf_end","display","flex"),e&&(this.playerSpied=e,this.grid=this.players[e].grid),!this.dojoGame.isSpectator||this.ended)this.mode="view";else if(!this.modeRandom)if(this.puzzleUsers){const t=this.puzzleUsers[e];this.puzzle=this.players[t].puzzle}else this.puzzle=void 0;this.dojoGame&&this.setup()}else dojo.style("lrf_spectator","display","flex"),dojo.style("lrf_main","display","none")}catch(e){console.error("Error in displayPuzzle",e)}},refreshPuzzle:function(e){try{if(!e&&this.playerSpied&&(e=this.playerSpied),this.playerSpied===e){if(this.grid=this.players[e].grid,!this.modeRandom)if(this.dojoGame.isSpectator&&this.puzzleUsers&&!this.ended){const t=this.puzzleUsers[e];this.puzzle=this.players[t].puzzle}else this.puzzle=void 0;this.setup()}}catch(e){console.error("Error in refreshPuzzle",e)}},displayTeamSelection:function(){dojo.style("lrf_main","display","none"),dojo.style("lrf_teams","display","flex");const e=this.players[this.playerId].team;e&&dojo.addClass("lrf_team_"+e,"lrf_team_selected")},hideTeamSelection:function(){dojo.style("lrf_main","display",""),dojo.style("lrf_teams","display","none")},selectTeam:function(e){for(let t=1;t<=3;t++)e===t?dojo.addClass("lrf_team_"+t,"lrf_team_selected"):dojo.removeClass("lrf_team_"+t,"lrf_team_selected");this.players[this.playerId].team!==e&&this.callAction("teamSelect",{no:this.players[this.playerId].num,team:e},!0)},displayPlayerTeam:function(e){const t="player_board_"+e,i="icon_"+e,s=["","ðŸ§™â€â™‚ï¸","ðŸ‘½","ðŸ§›"][this.players[e].team];dojo.destroy(i),dojo.place("<span id='"+i+"'>"+s+"</span>",$(t).firstElementChild,0)},displayPlayerTeams:function(){Object.keys(this.players).map((e=>{this.displayPlayerTeam(e)}))}};